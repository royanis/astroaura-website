<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astrological Accuracy Verification</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a2e; color: #fff; }
        .test-result { margin: 15px 0; padding: 15px; border-radius: 8px; }
        .success { background: #0d4f3c; border-left: 5px solid #4CAF50; }
        .warning { background: #4a3c00; border-left: 5px solid #FF9800; }
        .error { background: #4a1c1c; border-left: 5px solid #f44336; }
        .info { background: #1e3a5f; border-left: 5px solid #2196F3; }
        pre { background: #2a2a3a; padding: 15px; overflow-x: auto; border-radius: 5px; }
        h1, h2 { color: #F0C75E; }
        .comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0; }
        .expected, .actual { background: #2a2a3a; padding: 15px; border-radius: 8px; }
        .expected h4 { color: #4CAF50; }
        .actual h4 { color: #2196F3; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #444; }
        th { background: #3a3a4a; }
    </style>
</head>
<body>
    <h1>Astrological Accuracy Verification</h1>
    <p><strong>Test Case:</strong> January 4, 1985, 6:30 AM, Prayagraj, India (25.4358°N, 81.8463°E)</p>
    
    <div id="testResults"></div>
    
    <button onclick="runAccuracyTest()" style="padding: 10px 20px; background: #F0C75E; color: #1a1a2e; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-right: 10px;">Run Primary Test</button>
    <button onclick="runComprehensiveTests()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-right: 10px;">Run All Tests</button>
    <button onclick="runTimezoneTests()" style="padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-right: 10px;">Timezone Tests</button>
    <button onclick="runDiagnostics()" style="padding: 10px 20px; background: #FF9800; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Run Diagnostics</button>
    
    <!-- Load dependencies in correct order -->
    <script src="assets/js/vsop87-series-data.js"></script>
    <script src="assets/js/elp2000-series-data.js"></script>
    <script src="assets/js/nutation-calculator.js"></script>
    <script src="assets/js/coordinate-transformer.js"></script>
    <script src="assets/js/elp2000-moon-calculator.js"></script>
    <script src="assets/js/performance-monitor.js"></script>
    <script src="assets/js/calculation-error-handler.js"></script>
    <script src="assets/js/vsop87-calculator.js"></script>
    <script src="assets/js/geocoding-service.js"></script>
    <script src="assets/js/timezone-service.js"></script>
    <script src="assets/js/timezone-aware-converter.js"></script>
    <script src="assets/js/chart-interpretation.js"></script>
    <script src="assets/js/calculation-validator.js"></script>
    <script src="assets/js/test-cases.js"></script>
    <script src="assets/js/diagnostic-tools.js"></script>
    <script src="assets/js/birth-chart-calculator.js"></script>
    
    <script>
        // Known astronomical data for verification (from Swiss Ephemeris/NASA)
        const expectedData = {
            date: '1985-01-04',
            time: '6:30',
            location: 'Prayagraj, India',
            coordinates: { lat: 25.4358, lng: 81.8463 },
            
            // Expected planetary positions for Jan 4, 1985, 01:00 UT 
            // (Based on astro-seek.com ephemeris for 00:00 UT + hourly motion)
            expectedPositions: {
                Sun: { longitude: 283.61, sign: 'Capricorn', degree: 13.61 }, // 13°37' Cap (00:00) + ~2' motion
                Moon: { longitude: 66.73, sign: 'Gemini', degree: 6.73 },     // 6°44' Gem (00:00) + ~30' motion  
                Mercury: { longitude: 260.78, sign: 'Sagittarius', degree: 20.78 }, // 20°47' Sag (slow motion)
                Venus: { longitude: 329.71, sign: 'Aquarius', degree: 29.71 }, // 29°43' Aqu (slow motion)
                Mars: { longitude: 337.42, sign: 'Pisces', degree: 7.42 },    // 7°25' Pis + ~1' motion
                Jupiter: { longitude: 292.15, sign: 'Capricorn', degree: 22.15 }, // 22°09' Cap (very slow)
                Saturn: { longitude: 235.00, sign: 'Scorpio', degree: 25.00 }, // 25°00' Sco (very slow)
                Uranus: { longitude: 255.53, sign: 'Sagittarius', degree: 15.53 }, // 15°32' Sag (very slow)
                Neptune: { longitude: 271.58, sign: 'Capricorn', degree: 1.58 }, // 1°35' Cap (extremely slow)
                Pluto: { longitude: 214.42, sign: 'Scorpio', degree: 4.42 }   // 4°25' Sco (extremely slow)
            },
            
            // Expected house positions (Placidus system)
            expectedHouses: {
                1: { sign: 'Capricorn', degree: 7 },   // ASC in Capricorn
                10: { sign: 'Libra', degree: 23 }      // MC in Libra
            }
        };

        async function runAccuracyTest() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<div class="info">Running astronomical accuracy verification...</div>';
            
            try {
                console.log('Starting accuracy verification...');
                
                // Initialize calculator for testing (skip DOM setup)
                const calculator = new BirthChartCalculator(true);
                
                // Set test birth data with proper timezone object
                calculator.birthData = {
                    date: expectedData.date,
                    time: expectedData.time,
                    location: {
                        name: expectedData.location,
                        lat: expectedData.coordinates.lat,
                        lng: expectedData.coordinates.lng,
                        timezone: {
                            name: 'Asia/Kolkata',
                            offset: 5.5,
                            dst: false,
                            source: 'test'
                        }
                    }
                };
                
                // Debug: Manual UTC conversion and Julian Day calculation
                console.log('=== DEBUGGING TIME CONVERSION ===');
                console.log('Input date:', expectedData.date, 'time:', expectedData.time);
                
                // Manual UTC conversion: 6:30 AM IST = 1:00 AM UTC (SAME DAY)
                // Create date in UTC directly: 6:30 AM IST = 1:00 AM UTC same day
                const utcDate = new Date(`${expectedData.date}T01:00:00.000Z`);
                console.log('Manual UTC conversion:', utcDate.toISOString());
                
                // Manual Julian Day calculation for UTC time
                const manualJD = calculator.calculateJulianDay(utcDate);
                console.log('Manual Julian Day for 1:00 AM UTC:', manualJD);
                
                // Reference Julian Day calculation (cross-check)
                const refJD = calculateReferenceJulianDay(1985, 1, 4, 1, 0, 0);
                console.log('Reference Julian Day calculation:', refJD);
                
                // OUR JULIAN DAY CALCULATION IS CORRECT!
                // Jan 4, 1985, 1:00 AM UTC = JD 2446069.54167
                const expectedJD = 2446069.54167; // Jan 4, 1985, 1:00 AM UTC (CORRECTED)
                console.log('Expected Julian Day:', expectedJD, 'Difference:', Math.abs(manualJD - expectedJD));
                
                // Perform calculations
                const chartData = await calculator.performAstrologicalCalculations();
                console.log('Calculations completed:', chartData);
                
                // Debug: Show what our VSOP87 calculator is producing
                console.log('=== DEBUGGING VSOP87 CALCULATIONS ===');
                const vsopCalculator = new VSOP87Calculator();
                const testPlanets = vsopCalculator.calculatePlanetaryPositions(manualJD);
                console.log('VSOP87 direct calculation results:');
                testPlanets.forEach(planet => {
                    console.log(`${planet.name}: ${planet.longitude.toFixed(4)}° (${planet.sign} ${planet.degree}°)`);
                });
                
                // Verify calculations
                const verificationResults = verifyCalculations(chartData, expectedData);
                
                // Display results
                displayVerificationResults(verificationResults, chartData, expectedData, resultsDiv);
                
            } catch (error) {
                console.error('Accuracy test failed:', error);
                resultsDiv.innerHTML = `<div class="error">
                    <h3>Verification Failed</h3>
                    <p>Error: ${error.message}</p>
                    <pre>${error.stack}</pre>
                </div>`;
            }
        }
        
        function verifyCalculations(actual, expected) {
            const results = {
                overall: 'success',
                issues: [],
                planetary: {},
                houses: {},
                timezone: {},
                julianDay: {}
            };
            
            // Verify planetary positions
            for (const [planet, expectedPos] of Object.entries(expected.expectedPositions)) {
                const actualPlanet = actual.planets.find(p => p.name === planet);
                if (!actualPlanet) {
                    results.issues.push(`Missing planet: ${planet}`);
                    results.overall = 'error';
                    continue;
                }
                
                const longitudeDiff = Math.abs(actualPlanet.longitude - expectedPos.longitude);
                const normalizedDiff = longitudeDiff > 180 ? 360 - longitudeDiff : longitudeDiff;
                
                results.planetary[planet] = {
                    expected: expectedPos,
                    actual: {
                        longitude: actualPlanet.longitude,
                        sign: actualPlanet.sign,
                        degree: actualPlanet.degree
                    },
                    difference: normalizedDiff,
                    status: normalizedDiff < 5 ? 'success' : normalizedDiff < 15 ? 'warning' : 'error'
                };
                
                if (normalizedDiff > 15) {
                    results.issues.push(`${planet} position difference: ${normalizedDiff.toFixed(2)}°`);
                    results.overall = 'warning';
                }
            }
            
            // Verify Julian Day (should be around 2446067.77 for this date/time)
            const expectedJD = 2446067.77; // Approximate
            const jdDiff = Math.abs(actual.birthInfo.julianDay - expectedJD);
            results.julianDay = {
                expected: expectedJD,
                actual: actual.birthInfo.julianDay,
                difference: jdDiff,
                status: jdDiff < 0.5 ? 'success' : 'warning'
            };
            
            if (jdDiff > 0.5) {
                results.issues.push(`Julian Day difference: ${jdDiff.toFixed(4)} days`);
                results.overall = 'warning';
            }
            
            return results;
        }
        
        function displayVerificationResults(verification, actual, expected, container) {
            let html = `
                <div class="test-result ${verification.overall}">
                    <h2>Verification Results: ${verification.overall.toUpperCase()}</h2>
                    ${verification.issues.length > 0 ? 
                        `<p><strong>Issues Found:</strong> ${verification.issues.join(', ')}</p>` : 
                        '<p><strong>All calculations within acceptable ranges!</strong></p>'
                    }
                </div>
            `;
            
            // Julian Day verification
            html += `
                <div class="test-result ${verification.julianDay.status}">
                    <h3>Julian Day Verification</h3>
                    <div class="comparison">
                        <div class="expected">
                            <h4>Expected</h4>
                            <p>JD: ${verification.julianDay.expected}</p>
                        </div>
                        <div class="actual">
                            <h4>Calculated</h4>
                            <p>JD: ${verification.julianDay.actual.toFixed(6)}</p>
                            <p>Difference: ${verification.julianDay.difference.toFixed(4)} days</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Planetary positions verification
            html += `
                <div class="test-result info">
                    <h3>Planetary Positions Verification</h3>
                    <table>
                        <tr>
                            <th>Planet</th>
                            <th>Expected</th>
                            <th>Calculated</th>
                            <th>Difference</th>
                            <th>Status</th>
                        </tr>
            `;
            
            for (const [planet, data] of Object.entries(verification.planetary)) {
                const statusColor = data.status === 'success' ? '#4CAF50' : 
                                  data.status === 'warning' ? '#FF9800' : '#f44336';
                html += `
                    <tr>
                        <td><strong>${planet}</strong></td>
                        <td>${data.expected.sign} ${data.expected.degree}° (${data.expected.longitude.toFixed(2)}°)</td>
                        <td>${data.actual.sign} ${data.actual.degree}° (${data.actual.longitude.toFixed(2)}°)</td>
                        <td>${data.difference.toFixed(2)}°</td>
                        <td style="color: ${statusColor}; font-weight: bold">${data.status.toUpperCase()}</td>
                    </tr>
                `;
            }
            
            html += `
                    </table>
                </div>
            `;
            
            // Birth info
            html += `
                <div class="test-result info">
                    <h3>Birth Information</h3>
                    <pre>${JSON.stringify(actual.birthInfo, null, 2)}</pre>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // Reference Julian Day calculation for cross-validation
        function calculateReferenceJulianDay(year, month, day, hour, minute, second) {
            // Standard algorithm from Astronomical Algorithms by Jean Meeus
            let a, b;
            
            if (month <= 2) {
                year = year - 1;
                month = month + 12;
            }
            
            // Gregorian calendar
            a = Math.floor(year / 100);
            b = 2 - a + Math.floor(a / 4);
            
            const JD = Math.floor(365.25 * (year + 4716)) + 
                      Math.floor(30.6001 * (month + 1)) + 
                      day + b - 1524.5;
            
            // Add time fraction
            const timeFraction = (hour + minute / 60 + second / 3600) / 24;
            
            return JD + timeFraction;
        }

        /**
         * Run comprehensive timezone conversion tests
         * Tests the critical fix for timezone conversion issues
         */
        async function runTimezoneTests() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<div class="info">Running timezone conversion validation tests...</div>';
            
            try {
                console.log('Starting timezone conversion tests...');
                
                // Initialize timezone converter
                const timezoneService = new TimezoneService();
                const timezoneConverter = new TimezoneAwareConverter(timezoneService);
                timezoneConverter.enableDebugMode();
                
                // Test cases for timezone conversion
                const testCases = [
                    {
                        name: 'Primary Test Case - India IST',
                        date: '1985-01-04',
                        time: '06:30',
                        location: {
                            name: 'Prayagraj, India',
                            lat: 25.4358,
                            lng: 81.8463,
                            timezone: { name: 'Asia/Kolkata', offset: 5.5, dst: false }
                        },
                        expectedUTC: '1985-01-04T01:00:00.000Z',
                        description: 'Critical test: 6:30 AM IST should convert to 1:00 AM UTC'
                    },
                    {
                        name: 'US Eastern Time (No DST)',
                        date: '1985-01-04',
                        time: '12:00',
                        location: {
                            name: 'New York, USA',
                            lat: 40.7128,
                            lng: -74.0060,
                            timezone: { name: 'America/New_York', offset: -5, dst: false }
                        },
                        expectedUTC: '1985-01-04T17:00:00.000Z',
                        description: '12:00 PM EST should convert to 5:00 PM UTC'
                    },
                    {
                        name: 'UK GMT',
                        date: '1985-01-04',
                        time: '15:30',
                        location: {
                            name: 'London, UK',
                            lat: 51.5074,
                            lng: -0.1278,
                            timezone: { name: 'Europe/London', offset: 0, dst: false }
                        },
                        expectedUTC: '1985-01-04T15:30:00.000Z',
                        description: '3:30 PM GMT should convert to 3:30 PM UTC'
                    },
                    {
                        name: 'Australia AEST',
                        date: '1985-01-04',
                        time: '09:00',
                        location: {
                            name: 'Sydney, Australia',
                            lat: -33.8688,
                            lng: 151.2093,
                            timezone: { name: 'Australia/Sydney', offset: 10, dst: false }
                        },
                        expectedUTC: '1985-01-03T23:00:00.000Z',
                        description: '9:00 AM AEST should convert to 11:00 PM UTC previous day'
                    },
                    {
                        name: 'Japan JST',
                        date: '1985-01-04',
                        time: '18:45',
                        location: {
                            name: 'Tokyo, Japan',
                            lat: 35.6762,
                            lng: 139.6503,
                            timezone: { name: 'Asia/Tokyo', offset: 9, dst: false }
                        },
                        expectedUTC: '1985-01-04T09:45:00.000Z',
                        description: '6:45 PM JST should convert to 9:45 AM UTC'
                    }
                ];
                
                const testResults = [];
                
                // Run each test case
                for (const testCase of testCases) {
                    console.log(`\n=== Testing: ${testCase.name} ===`);
                    
                    try {
                        const result = await timezoneConverter.convertBirthTimeToUTC(
                            testCase.date,
                            testCase.time,
                            testCase.location
                        );
                        
                        const actualUTC = result.utc.toISOString();
                        const expectedUTC = testCase.expectedUTC;
                        const timeDiff = Math.abs(new Date(actualUTC).getTime() - new Date(expectedUTC).getTime()) / (1000 * 60); // minutes
                        
                        const testResult = {
                            name: testCase.name,
                            description: testCase.description,
                            input: `${testCase.date} ${testCase.time} (${testCase.location.timezone.name})`,
                            expected: expectedUTC,
                            actual: actualUTC,
                            timeDifference: timeDiff,
                            status: timeDiff <= 1 ? 'success' : timeDiff <= 15 ? 'warning' : 'error',
                            details: result
                        };
                        
                        testResults.push(testResult);
                        
                        console.log(`Result: ${testResult.status.toUpperCase()}`);
                        console.log(`Expected: ${expectedUTC}`);
                        console.log(`Actual: ${actualUTC}`);
                        console.log(`Difference: ${timeDiff.toFixed(1)} minutes`);
                        
                    } catch (error) {
                        console.error(`Test failed: ${testCase.name}`, error);
                        testResults.push({
                            name: testCase.name,
                            description: testCase.description,
                            input: `${testCase.date} ${testCase.time} (${testCase.location.timezone.name})`,
                            expected: testCase.expectedUTC,
                            actual: 'ERROR',
                            timeDifference: null,
                            status: 'error',
                            error: error.message
                        });
                    }
                }
                
                // Display results
                displayTimezoneTestResults(testResults, resultsDiv);
                
            } catch (error) {
                console.error('Timezone tests failed:', error);
                resultsDiv.innerHTML = `<div class="error">
                    <h3>Timezone Tests Failed</h3>
                    <p>Error: ${error.message}</p>
                    <pre>${error.stack}</pre>
                </div>`;
            }
        }
        
        /**
         * Display timezone test results
         */
        function displayTimezoneTestResults(testResults, container) {
            const successCount = testResults.filter(r => r.status === 'success').length;
            const warningCount = testResults.filter(r => r.status === 'warning').length;
            const errorCount = testResults.filter(r => r.status === 'error').length;
            
            const overallStatus = errorCount > 0 ? 'error' : warningCount > 0 ? 'warning' : 'success';
            
            let html = `
                <div class="test-result ${overallStatus}">
                    <h2>Timezone Conversion Test Results</h2>
                    <p><strong>Summary:</strong> ${successCount} passed, ${warningCount} warnings, ${errorCount} failed</p>
                    <p><strong>Overall Status:</strong> ${overallStatus.toUpperCase()}</p>
                </div>
            `;
            
            // Individual test results
            html += `
                <div class="test-result info">
                    <h3>Individual Test Results</h3>
                    <table>
                        <tr>
                            <th>Test Case</th>
                            <th>Input</th>
                            <th>Expected UTC</th>
                            <th>Actual UTC</th>
                            <th>Difference</th>
                            <th>Status</th>
                        </tr>
            `;
            
            for (const result of testResults) {
                const statusColor = result.status === 'success' ? '#4CAF50' : 
                                  result.status === 'warning' ? '#FF9800' : '#f44336';
                
                const timeDiffText = result.timeDifference !== null ? 
                    `${result.timeDifference.toFixed(1)} min` : 'N/A';
                
                html += `
                    <tr>
                        <td>
                            <strong>${result.name}</strong><br>
                            <small>${result.description}</small>
                        </td>
                        <td><code>${result.input}</code></td>
                        <td><code>${result.expected}</code></td>
                        <td><code>${result.actual}</code></td>
                        <td>${timeDiffText}</td>
                        <td style="color: ${statusColor}; font-weight: bold">
                            ${result.status.toUpperCase()}
                            ${result.error ? `<br><small>${result.error}</small>` : ''}
                        </td>
                    </tr>
                `;
            }
            
            html += `
                    </table>
                </div>
            `;
            
            // Critical test case details
            const criticalTest = testResults.find(r => r.name.includes('Primary Test Case'));
            if (criticalTest) {
                html += `
                    <div class="test-result ${criticalTest.status}">
                        <h3>Critical Test Case: India IST Conversion</h3>
                        <p><strong>This test validates the main timezone conversion fix</strong></p>
                        <div class="comparison">
                            <div class="expected">
                                <h4>Expected Behavior</h4>
                                <p>6:30 AM IST (UTC+5:30) on Jan 4, 1985</p>
                                <p>Should convert to: <strong>1:00 AM UTC</strong> same day</p>
                                <p>Calculation: 6:30 - 5:30 = 1:00</p>
                            </div>
                            <div class="actual">
                                <h4>Actual Result</h4>
                                <p>Input: ${criticalTest.input}</p>
                                <p>Output: <strong>${criticalTest.actual}</strong></p>
                                <p>Difference: ${criticalTest.timeDifference ? criticalTest.timeDifference.toFixed(1) + ' minutes' : 'N/A'}</p>
                                <p>Status: <span style="color: ${criticalTest.status === 'success' ? '#4CAF50' : '#f44336'}">${criticalTest.status.toUpperCase()}</span></p>
                            </div>
                        </div>
                        ${criticalTest.status === 'success' ? 
                            '<p style="color: #4CAF50; font-weight: bold;">✓ Timezone conversion fix is working correctly!</p>' :
                            '<p style="color: #f44336; font-weight: bold;">✗ Timezone conversion issue still exists!</p>'
                        }
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        /**
         * Run comprehensive accuracy tests using the new validation system
         */
        async function runComprehensiveTests() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<div class="info">Running comprehensive accuracy validation tests...</div>';
            
            try {
                console.log('Starting comprehensive accuracy tests...');
                
                // Initialize validator and calculator
                const validator = new CalculationValidator();
                const calculator = new BirthChartCalculator(true);
                
                // Get high priority test cases
                const testCases = getHighPriorityTestCases();
                console.log(`Running ${testCases.length} high priority test cases`);
                
                const allResults = [];
                
                // Run each test case
                for (const testCase of testCases) {
                    console.log(`\n=== Testing: ${testCase.name} ===`);
                    
                    try {
                        // Set birth data
                        calculator.birthData = {
                            date: testCase.date,
                            time: testCase.time,
                            location: testCase.location
                        };
                        
                        // Perform calculations
                        const chartData = await calculator.performAstrologicalCalculations();
                        
                        // Validate results
                        const validationResults = validator.validatePlanetaryPositions(
                            chartData.planets, 
                            testCase.utcDateTime
                        );
                        
                        // Add test case info to results
                        validationResults.testCase = testCase;
                        validationResults.chartData = chartData;
                        
                        allResults.push(validationResults);
                        
                        console.log(`${testCase.name}: ${validationResults.summary}`);
                        
                    } catch (error) {
                        console.error(`Test case failed: ${testCase.name}`, error);
                        allResults.push({
                            testCase: testCase,
                            error: error.message,
                            summary: `ERROR: ${error.message}`,
                            overall: { passed: 0, failed: 1, warnings: 0 }
                        });
                    }
                }
                
                // Display comprehensive results
                displayComprehensiveResults(allResults, resultsDiv);
                
            } catch (error) {
                console.error('Comprehensive tests failed:', error);
                resultsDiv.innerHTML = `<div class="error">
                    <h3>Comprehensive Tests Failed</h3>
                    <p>Error: ${error.message}</p>
                    <pre>${error.stack}</pre>
                </div>`;
            }
        }
        
        /**
         * Display comprehensive test results
         */
        function displayComprehensiveResults(allResults, container) {
            // Calculate overall statistics
            let totalPassed = 0, totalFailed = 0, totalWarnings = 0;
            let successfulTests = 0, failedTests = 0;
            
            for (const result of allResults) {
                if (result.error) {
                    failedTests++;
                    totalFailed++;
                } else {
                    successfulTests++;
                    totalPassed += result.overall.passed;
                    totalFailed += result.overall.failed;
                    totalWarnings += result.overall.warnings;
                }
            }
            
            const overallStatus = failedTests > 0 ? 'error' : totalFailed > 0 ? 'warning' : 'success';
            
            let html = `
                <div class="test-result ${overallStatus}">
                    <h2>Comprehensive Accuracy Test Results</h2>
                    <p><strong>Test Cases:</strong> ${successfulTests}/${allResults.length} completed successfully</p>
                    <p><strong>Planetary Positions:</strong> ${totalPassed} passed, ${totalWarnings} warnings, ${totalFailed} failed</p>
                    <p><strong>Overall Status:</strong> ${overallStatus.toUpperCase()}</p>
                </div>
            `;
            
            // Individual test case results
            for (const result of allResults) {
                const testCase = result.testCase;
                const status = result.error ? 'error' : 
                              result.overall.failed > 0 ? 'error' : 
                              result.overall.warnings > 0 ? 'warning' : 'success';
                
                html += `
                    <div class="test-result ${status}">
                        <h3>${testCase.name}</h3>
                        <p><strong>Description:</strong> ${testCase.description}</p>
                        <p><strong>Location:</strong> ${testCase.location.name} (${testCase.date} ${testCase.time})</p>
                        
                        ${result.error ? 
                            `<p style="color: #f44336;"><strong>ERROR:</strong> ${result.error}</p>` :
                            `<p><strong>Result:</strong> ${result.summary}</p>`
                        }
                        
                        ${!result.error && result.planets ? `
                            <details>
                                <summary>Planetary Position Details</summary>
                                <table style="margin-top: 10px;">
                                    <tr>
                                        <th>Planet</th>
                                        <th>Expected</th>
                                        <th>Calculated</th>
                                        <th>Difference</th>
                                        <th>Status</th>
                                    </tr>
                                    ${Object.entries(result.planets).map(([planet, data]) => `
                                        <tr>
                                            <td><strong>${planet}</strong></td>
                                            <td>${data.expected.sign} ${data.expected.degree}°${data.expected.minute}' (${data.expected.longitude.toFixed(2)}°)</td>
                                            <td>${data.calculated.sign} ${data.calculated.degree}°${data.calculated.minute}' (${data.calculated.longitude.toFixed(2)}°)</td>
                                            <td>${data.difference.arcMinutes.toFixed(1)}'</td>
                                            <td style="color: ${data.status === 'PASS' ? '#4CAF50' : data.status === 'WARNING' ? '#FF9800' : '#f44336'}">
                                                ${data.status}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </table>
                            </details>
                        ` : ''}
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        /**
         * Run diagnostic tests to identify calculation issues
         */
        async function runDiagnostics() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<div class="info">Running advanced diagnostic analysis...</div>';
            
            try {
                console.log('Starting advanced diagnostic analysis...');
                
                // Initialize components
                const validator = new CalculationValidator();
                const diagnosticTools = new DiagnosticTools();
                const calculator = new BirthChartCalculator(true);
                
                // Enable debug mode for detailed logging
                diagnosticTools.enableDebugMode();
                
                // Get primary test case for detailed analysis
                const primaryTest = getPrimaryTestCase();
                
                // Set birth data
                calculator.birthData = {
                    date: primaryTest.date,
                    time: primaryTest.time,
                    location: primaryTest.location
                };
                
                // Perform calculations with detailed logging
                console.log('=== ADVANCED DIAGNOSTIC CALCULATION ANALYSIS ===');
                diagnosticTools.logCalculationStep('INPUT_DATA', {
                    testCase: primaryTest.name,
                    birthData: calculator.birthData
                });
                
                const chartData = await calculator.performAstrologicalCalculations();
                
                diagnosticTools.logCalculationStep('CALCULATION_COMPLETE', {
                    planetCount: chartData.planets.length,
                    julianDay: chartData.birthInfo.julianDay
                });
                
                // Validate results using standard validator
                const validationResults = validator.validatePlanetaryPositions(
                    chartData.planets, 
                    primaryTest.utcDateTime
                );
                
                // Perform advanced accuracy analysis
                const accuracyAnalysis = diagnosticTools.analyzePlanetaryAccuracy(
                    chartData.planets,
                    primaryTest.expected
                );
                
                // Generate comprehensive diagnostic report
                const comprehensiveReport = diagnosticTools.generateComprehensiveReport(accuracyAnalysis);
                
                // Check for range issues
                const rangeIssues = validator.validateRanges(chartData.planets);
                
                // Get calculation log
                const calculationLog = diagnosticTools.getCalculationLog();
                
                // Display advanced diagnostic results
                displayAdvancedDiagnosticResults(
                    validationResults, 
                    accuracyAnalysis, 
                    comprehensiveReport, 
                    rangeIssues, 
                    calculationLog,
                    chartData, 
                    primaryTest, 
                    resultsDiv
                );
                
            } catch (error) {
                console.error('Advanced diagnostic analysis failed:', error);
                resultsDiv.innerHTML = `<div class="error">
                    <h3>Advanced Diagnostic Analysis Failed</h3>
                    <p>Error: ${error.message}</p>
                    <pre>${error.stack}</pre>
                </div>`;
            }
        }
        
        /**
         * Display advanced diagnostic results
         */
        function displayAdvancedDiagnosticResults(validationResults, accuracyAnalysis, comprehensiveReport, rangeIssues, calculationLog, chartData, testCase, container) {
            let html = `
                <div class="test-result info">
                    <h2>Advanced Diagnostic Analysis Results</h2>
                    <p><strong>Test Case:</strong> ${testCase.name}</p>
                    <p><strong>Analysis Date:</strong> ${new Date().toLocaleString()}</p>
                    <p><strong>Accuracy Rate:</strong> ${accuracyAnalysis.summary.accuracyRate.toFixed(1)}%</p>
                </div>
            `;
            
            // Accuracy Summary
            const summaryStatus = accuracyAnalysis.summary.accuracyRate >= 80 ? 'success' : 
                                 accuracyAnalysis.summary.accuracyRate >= 60 ? 'warning' : 'error';
            
            html += `
                <div class="test-result ${summaryStatus}">
                    <h3>Accuracy Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <strong>Planet Count:</strong> ${accuracyAnalysis.summary.totalPlanets}<br>
                            <strong>Excellent:</strong> ${accuracyAnalysis.summary.excellent}<br>
                            <strong>Good:</strong> ${accuracyAnalysis.summary.good}<br>
                            <strong>Acceptable:</strong> ${accuracyAnalysis.summary.acceptable}<br>
                            <strong>Poor:</strong> ${accuracyAnalysis.summary.poor}
                        </div>
                        <div>
                            <strong>Average Error:</strong> ${accuracyAnalysis.summary.averageError.toFixed(2)}'<br>
                            <strong>Max Error:</strong> ${accuracyAnalysis.summary.maxError.toFixed(2)}' (${accuracyAnalysis.summary.worstPlanet})<br>
                            <strong>Min Error:</strong> ${accuracyAnalysis.summary.minError.toFixed(2)}' (${accuracyAnalysis.summary.bestPlanet})<br>
                            <strong>Accuracy Rate:</strong> ${accuracyAnalysis.summary.accuracyRate.toFixed(1)}%
                        </div>
                    </div>
                </div>
            `;
            
            // Identified Patterns
            if (accuracyAnalysis.patterns.length > 0) {
                html += `
                    <div class="test-result warning">
                        <h3>Identified Patterns</h3>
                        <ul>
                            ${accuracyAnalysis.patterns.map(pattern => `
                                <li>
                                    <strong>[${pattern.severity}] ${pattern.type}:</strong> ${pattern.description}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // Recommendations
            if (accuracyAnalysis.recommendations.length > 0) {
                html += `
                    <div class="test-result info">
                        <h3>Recommendations</h3>
                        ${accuracyAnalysis.recommendations.map(rec => `
                            <div style="margin-bottom: 15px; padding: 10px; background: #3a3a4a; border-radius: 5px;">
                                <strong>[${rec.priority}] ${rec.category}:</strong> ${rec.description}
                                <ul style="margin-top: 5px;">
                                    ${rec.actions.map(action => `<li>${action}</li>`).join('')}
                                </ul>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Range validation issues
            if (rangeIssues.length > 0) {
                html += `
                    <div class="test-result error">
                        <h3>Range Validation Issues</h3>
                        <ul>
                            ${rangeIssues.map(issue => `<li>${issue}</li>`).join('')}
                        </ul>
                    </div>
                `;
            } else {
                html += `
                    <div class="test-result success">
                        <h3>Range Validation</h3>
                        <p>✓ All planetary positions are within valid ranges (0-360°)</p>
                    </div>
                `;
            }
            
            // Detailed planetary analysis
            html += `
                <div class="test-result info">
                    <h3>Detailed Planetary Analysis</h3>
                    <table>
                        <tr>
                            <th>Planet</th>
                            <th>Calculated</th>
                            <th>Expected</th>
                            <th>Error</th>
                            <th>Accuracy</th>
                            <th>Motion</th>
                        </tr>
                        ${Object.entries(accuracyAnalysis.details).map(([planet, details]) => {
                            const accuracyColor = details.accuracy === 'EXCELLENT' ? '#4CAF50' :
                                                 details.accuracy === 'GOOD' ? '#8BC34A' :
                                                 details.accuracy === 'ACCEPTABLE' ? '#FF9800' : '#f44336';
                            return `
                                <tr>
                                    <td><strong>${planet}</strong></td>
                                    <td>${details.calculated.toFixed(4)}°</td>
                                    <td>${details.expected.toFixed(4)}°</td>
                                    <td>${details.arcMinutes.toFixed(1)}'</td>
                                    <td style="color: ${accuracyColor}; font-weight: bold">${details.accuracy}</td>
                                    <td>${details.motionAnalysis.motionCategory}</td>
                                </tr>
                            `;
                        }).join('')}
                    </table>
                </div>
            `;
            
            // Comprehensive report
            html += `
                <div class="test-result info">
                    <h3>Comprehensive Diagnostic Report</h3>
                    <details>
                        <summary>View Full Report</summary>
                        <pre style="white-space: pre-wrap; font-size: 11px; max-height: 400px; overflow-y: auto;">${comprehensiveReport}</pre>
                    </details>
                </div>
            `;
            
            // Calculation log
            if (calculationLog.length > 0) {
                html += `
                    <div class="test-result info">
                        <h3>Calculation Log</h3>
                        <details>
                            <summary>View Calculation Steps (${calculationLog.length} entries)</summary>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${calculationLog.map(entry => `
                                    <div style="margin: 5px 0; padding: 5px; background: #2a2a3a; border-radius: 3px;">
                                        <strong>${entry.step}</strong> <small>(${entry.timestamp})</small>
                                        <pre style="font-size: 10px; margin: 5px 0;">${JSON.stringify(entry.data, null, 2)}</pre>
                                    </div>
                                `).join('')}
                            </div>
                        </details>
                    </div>
                `;
            }
            
            // Raw calculation data
            html += `
                <div class="test-result info">
                    <h3>Raw Calculation Data</h3>
                    <details>
                        <summary>Birth Information</summary>
                        <pre>${JSON.stringify(chartData.birthInfo, null, 2)}</pre>
                    </details>
                    <details>
                        <summary>Planetary Data</summary>
                        <pre>${JSON.stringify(chartData.planets, null, 2)}</pre>
                    </details>
                </div>
            `;
            
            container.innerHTML = html;
        }

        /**
         * Display diagnostic results (legacy function for compatibility)
         */
        function displayDiagnosticResults(validationResults, diagnosticReport, rangeIssues, chartData, testCase, container) {
            let html = `
                <div class="test-result info">
                    <h2>Diagnostic Analysis Results</h2>
                    <p><strong>Test Case:</strong> ${testCase.name}</p>
                    <p><strong>Analysis Date:</strong> ${new Date().toLocaleString()}</p>
                </div>
            `;
            
            // Range validation issues
            if (rangeIssues.length > 0) {
                html += `
                    <div class="test-result error">
                        <h3>Range Validation Issues</h3>
                        <ul>
                            ${rangeIssues.map(issue => `<li>${issue}</li>`).join('')}
                        </ul>
                    </div>
                `;
            } else {
                html += `
                    <div class="test-result success">
                        <h3>Range Validation</h3>
                        <p>✓ All planetary positions are within valid ranges (0-360°)</p>
                    </div>
                `;
            }
            
            // Detailed diagnostic report
            html += `
                <div class="test-result info">
                    <h3>Detailed Diagnostic Report</h3>
                    <pre style="white-space: pre-wrap; font-size: 12px;">${diagnosticReport}</pre>
                </div>
            `;
            
            // Calculation details
            html += `
                <div class="test-result info">
                    <h3>Calculation Details</h3>
                    <details>
                        <summary>Birth Information</summary>
                        <pre>${JSON.stringify(chartData.birthInfo, null, 2)}</pre>
                    </details>
                    <details>
                        <summary>Raw Planetary Data</summary>
                        <pre>${JSON.stringify(chartData.planets, null, 2)}</pre>
                    </details>
                </div>
            `;
            
            // Recommendations
            const recommendations = generateRecommendations(validationResults, rangeIssues);
            if (recommendations.length > 0) {
                html += `
                    <div class="test-result warning">
                        <h3>Recommendations</h3>
                        <ul>
                            ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        /**
         * Generate recommendations based on diagnostic results
         */
        function generateRecommendations(validationResults, rangeIssues) {
            const recommendations = [];
            
            // Check for systematic errors
            const failedPlanets = Object.entries(validationResults.planets || {})
                .filter(([planet, data]) => data.status === 'FAIL')
                .map(([planet, data]) => planet);
            
            if (failedPlanets.length > 5) {
                recommendations.push('Multiple planetary positions are significantly inaccurate. Consider reviewing the VSOP87 implementation and coefficient data.');
            }
            
            if (failedPlanets.includes('Sun')) {
                recommendations.push('Sun position is inaccurate. Check VSOP87 Earth series calculation and coordinate transformations.');
            }
            
            if (failedPlanets.includes('Moon')) {
                recommendations.push('Moon position is inaccurate. Verify ELP2000 lunar theory implementation and periodic terms.');
            }
            
            if (rangeIssues.length > 0) {
                recommendations.push('Range validation issues detected. Check for calculation overflow, NaN values, or coordinate system errors.');
            }
            
            // Check for timezone issues
            if (validationResults.diagnostics && validationResults.diagnostics.some(d => d.includes('timezone'))) {
                recommendations.push('Timezone conversion issues detected. Verify TimezoneAwareConverter implementation.');
            }
            
            return recommendations;
        }

        // Auto-run test when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Enhanced accuracy verification page loaded');
            console.log('Available test functions: runAccuracyTest(), runComprehensiveTests(), runTimezoneTests(), runDiagnostics()');
        });
    </script>
</body>
</html>